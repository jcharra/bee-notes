"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([["default-src_app_services_reminder_service_ts-src_app_services_swarm-group_service_ts-src_app_-104507"],{7119:(A,p,t)=>{t.d(p,{Z:()=>M});var d=t(4929),i=t(7589);const h=(0,t(6549).fo)("LocalNotifications",{web:()=>t.e("node_modules_capacitor_local-notifications_dist_esm_web_js").then(t.bind(t,7671)).then(v=>new v.LocalNotificationsWeb)});var u=t(8325),g=t(1170);function F(v,U){(0,g.Z)(2,arguments);var r=(0,u.Z)(v),f=(0,u.Z)(U);return r.getTime()<f.getTime()}var y=t(7367);function m(v,U){(0,g.Z)(2,arguments);var r=(0,u.Z)(v),f=(0,y.Z)(U);return isNaN(f)?new Date(NaN):(f&&r.setDate(r.getDate()+f),r)}var b=t(9377),E=t(1511),R=t(4858),O=t(4139),S=t(9095),a=t(5670),e=t(6942),s=t(8759),o=t(4512),c=t(6723),l=t(5211),I=t(7503);let M=(()=>{class v{constructor(r,f,w,P){this.translate=r,this.db=f,this.authService=w,this.storageSync=P}getReminders(r){return console.log("Fetch for swarm",r),this.authService.getUser().pipe((0,S.w)(f=>(0,R.D)(this.storageSync.getFromStorage(o.F.REMINDERS,r)).pipe((0,S.w)(w=>w?(0,O.of)(w):(0,i.en)((0,E.iH)(this.db,`users/${f.uid}/reminders`),{keyField:"id"}).pipe((0,a.P)(),(0,e.U)(P=>{let G=[];for(let D=0;D<P.length;D++){const N=P[D];G.push(Object.assign(Object.assign({},N),{date:new Date(N.date)}))}const T=[],L=[];for(const D of G)F(D.date,(0,b.Z)(m(new Date,-3)))?T.push(D):L.push(D);this.cleanupReminders(T.map(D=>D.reminderId));const C=L.filter(r?D=>D.swarmId===r:D=>!D.swarmId);return this.storageSync.writeToStorage(o.F.REMINDERS,C,r),C}))))))}updateReminder(r){return(0,d.mG)(this,void 0,void 0,function*(){yield this.deleteReminder(Object.assign({},r)),yield this.createReminder(Object.assign({},r))})}createReminder(r){return(0,d.mG)(this,void 0,void 0,function*(){yield h.requestPermissions(),r.reminderId=Math.floor(1e9*Math.random()),yield h.schedule({notifications:[{title:r.swarmName?this.translate.instant("REMINDERS.title",{swarmName:r.swarmName}):this.translate.instant("REMINDERS.titleForGroup",{groupName:r.groupName}),body:r.text,id:r.reminderId,schedule:{at:new Date(r.date)},extra:{swarmId:r.swarmId}}]}),this.authService.getUser().pipe((0,a.P)(),(0,s.b)(f=>{(0,i.t8)((0,E.iH)(this.db,`users/${f.uid}/reminders/${r.reminderId}`),Object.assign(Object.assign({},r),{date:r.date.toISOString()}))})).subscribe(),this._markStorageAsDirty(r.swarmId)})}deleteReminder(r){return(0,d.mG)(this,void 0,void 0,function*(){console.log("Delete",r.reminderId),yield h.cancel({notifications:[{id:r.reminderId}]}),this.authService.getUser().pipe((0,a.P)(),(0,s.b)(f=>{(0,i.Od)((0,E.iH)(this.db,`/users/${f.uid}/reminders/${r.reminderId}`)),console.log("Remove from firebase",r.reminderId)})).subscribe(),this._markStorageAsDirty(r.swarmId)})}cleanupReminders(r){this.authService.getUser().pipe((0,a.P)(),(0,s.b)(f=>{for(const w of r)(0,i.Od)((0,E.iH)(this.db,`/users/${f.uid}/reminders/${w}`))})).subscribe()}_markStorageAsDirty(r){return console.log("Clear reminders from local storage for swarm",r),this.storageSync.clearFromStorage(o.F.REMINDERS,r)}}return v.\u0275fac=function(r){return new(r||v)(c.LFG(l.sK),c.LFG(i.vo),c.LFG(I.e),c.LFG(o.t))},v.\u0275prov=c.Yz7({token:v,factory:v.\u0275fac,providedIn:"root"}),v})()},2912:(A,p,t)=>{t.d(p,{N:()=>R});var d=t(7589),i=t(1511),n=t(4858),h=t(4139),u=t(9095),g=t(3910),F=t(6942),y=t(4512),m=t(6723),b=t(7503),E=t(287);let R=(()=>{class O{constructor(a,e,s,o){this.db=a,this.authService=e,this.geolocation=s,this.storageSync=o}getGroups(){return this.authService.getUser().pipe((0,u.w)(a=>(0,n.D)(this.storageSync.getFromStorage(y.F.GROUPS)).pipe((0,u.w)(e=>e?(0,h.of)(e):(0,d.en)((0,i.iH)(this.db,`/users/${a.uid}/groups`),{keyField:"id"}).pipe((0,g.q)(1),(0,F.U)(s=>{if(!s)return[];const o=[];for(let c=0;c<s.length;c++)o.push(this._entryFromFbValue(s[c]));return this.storageSync.writeToStorage(y.F.GROUPS,o),o}))))))}getGroup(a){return this.authService.getUser().pipe((0,u.w)(e=>(0,d.FE)((0,i.iH)(this.db,`/users/${e.uid}/groups/${a}`),{keyField:"id"}).pipe((0,g.q)(1),(0,F.U)(s=>s?this._entryFromFbValue(s):null))))}createGroup(a,e=[]){return this.authService.getUser().pipe((0,u.w)(s=>(this._markStorageAsDirty(),(0,i.VF)((0,i.iH)(this.db,`/users/${s.uid}/groups`),{name:a,swarmIds:e}))))}updateGroup(a){return this.authService.getUser().pipe((0,u.w)(e=>(this._markStorageAsDirty(),(0,i.Vx)((0,i.iH)(this.db,`/users/${e.uid}/groups/${a.id}`),a))))}addSwarmToGroup(a,e){return this.getGroup(e).pipe((0,u.w)(s=>{if(this._markStorageAsDirty(),!s)return;const o=(s.swarmIds||[]).concat(a);return this.updateGroup({id:s.id,name:s.name,swarmIds:o})}))}deleteGroup(a){return this.authService.getUser().pipe((0,u.w)(e=>(this._markStorageAsDirty(),(0,d.Od)((0,i.iH)(this.db,`/users/${e.uid}/groups/${a}`)))))}setLocation(a){return this.geolocation.getCurrentPosition().then(e=>this.updateGroup({id:a.id,name:a.name,swarmIds:a.swarms.map(s=>s.id),lat:Math.round(1e3*e.coords.latitude)/1e3,lng:Math.round(1e3*e.coords.longitude)/1e3}).subscribe())}_entryFromFbValue(a){let e=Object.assign({},a);return a.lat&&(e.lat=a.lat),a.lng&&(e.lng=a.lng),e}_markStorageAsDirty(){return this.storageSync.clearFromStorage(y.F.GROUPS)}}return O.\u0275fac=function(a){return new(a||O)(m.LFG(d.vo),m.LFG(b.e),m.LFG(E.b),m.LFG(y.t))},O.\u0275prov=m.Yz7({token:O,factory:O.\u0275fac,providedIn:"root"}),O})()},3235:(A,p,t)=>{t.d(p,{e:()=>O});var d=t(4929),i=t(7589),n=t(1511),h=t(4858),u=t(4139),g=t(9095),F=t(3910),y=t(6942),m=(()=>{return(S=m||(m={})).ACTIVE="ACTIVE",S.DECEASED="DECEASED",S.SOLD="SOLD",S.DISSOLVED="DISSOLVED",m;var S})(),b=t(4512),E=t(6723),R=t(7503);let O=(()=>{class S{constructor(e,s,o){this.db=e,this.authService=s,this.storageSync=o}getSwarms(e=[m.SOLD,m.DECEASED,m.DISSOLVED]){return this.authService.getUser().pipe((0,g.w)(s=>(console.log("User",s.uid),(0,h.D)(this.storageSync.getFromStorage(b.F.SWARMS)).pipe((0,g.w)(o=>o?(0,u.of)(o).pipe((0,F.q)(1),(0,y.U)(c=>c.map(l=>Object.assign(Object.assign({},l),{created:new Date(l.created)})).filter(l=>-1===e.indexOf(l.activityStatus)))):(0,i.en)((0,n.iH)(this.db,`users/${s.uid}/swarms`),{keyField:"id"}).pipe((0,F.q)(1),(0,y.U)(c=>{const l=[];for(let I=0;I<c.length;I++){const M=c[I];l.push(Object.assign(Object.assign({},M),{created:new Date(M.created)}))}return this.writeSwarmsToStorage(l),l.filter(I=>-1===e.indexOf(I.activityStatus))})))))))}getSwarm(e){return(0,h.D)(this.storageSync.getFromStorage(b.F.SWARMS)).pipe((0,g.w)(s=>{const o=s?s.filter(c=>c.id===e)[0]:null;return o?(0,u.of)(o):this.authService.getUser().pipe((0,g.w)(c=>(0,i.FE)((0,n.iH)(this.db,`users/${c.uid}/swarms/${e}`),{keyField:"id"}).pipe((0,F.q)(1),(0,y.U)(l=>({id:e,name:l.name,created:new Date(l.created),activityStatus:l.activityStatus,ancestorId:l.ancestorId,isNucleus:l.isNucleus,about:l.about})))))}))}createSwarm(e,s=null,o=!1,c=""){return this.authService.getUser().pipe((0,g.w)(l=>(0,d.mG)(this,void 0,void 0,function*(){yield this._markStorageAsDirty();const I={name:e,created:(new Date).toISOString(),activityStatus:m.ACTIVE,ancestorId:s,isNucleus:o,about:c};return(0,n.VF)((0,n.iH)(this.db,`/users/${l.uid}/swarms`),I).then(M=>{const v=M._path.pieces_;return v[v.length-1]})})))}updateSwarm(e){return this.authService.getUser().pipe((0,y.U)(s=>(0,d.mG)(this,void 0,void 0,function*(){yield this._markStorageAsDirty(),(0,n.Vx)((0,n.iH)(this.db,`/users/${s.uid}/swarms/${e.id}`),e)})))}markAsDeceased(e){return this.deactivate(e,m.DECEASED)}markAsSold(e){return this.deactivate(e,m.SOLD)}markAsDissolved(e){return this.deactivate(e,m.DISSOLVED)}getFormerSwarms(){return this.getSwarms([m.ACTIVE])}reactivate(e){return this.authService.getUser().pipe((0,g.w)(s=>(0,d.mG)(this,void 0,void 0,function*(){return yield this._markStorageAsDirty(),(0,n.Vx)((0,n.iH)(this.db,`/users/${s.uid}/swarms/${e.id}`),{activityStatus:m.ACTIVE})})))}deactivate(e,s){return this.authService.getUser().pipe((0,g.w)(o=>(0,d.mG)(this,void 0,void 0,function*(){return yield this._markStorageAsDirty(),(0,n.Vx)((0,n.iH)(this.db,`/users/${o.uid}/swarms/${e.id}`),{activityStatus:s})})))}writeSwarmsToStorage(e){this.storageSync.writeToStorage(b.F.SWARMS,e.map(s=>{let o=null;try{o=new Date(s.created).toISOString()}catch(c){}return Object.assign(Object.assign({},s),{created:o})}))}_markStorageAsDirty(){return this.storageSync.clearStorage()}}return S.\u0275fac=function(e){return new(e||S)(E.LFG(i.vo),E.LFG(R.e),E.LFG(b.t))},S.\u0275prov=E.Yz7({token:S,factory:S.\u0275fac,providedIn:"root"}),S})()},1170:(A,p,t)=>{function d(i,n){if(n.length<i)throw new TypeError(i+" argument"+(i>1?"s":"")+" required, but only "+n.length+" present")}t.d(p,{Z:()=>d})},7367:(A,p,t)=>{function d(i){if(null===i||!0===i||!1===i)return NaN;var n=Number(i);return isNaN(n)?n:n<0?Math.ceil(n):Math.floor(n)}t.d(p,{Z:()=>d})},9377:(A,p,t)=>{t.d(p,{Z:()=>n});var d=t(8325),i=t(1170);function n(h){(0,i.Z)(1,arguments);var u=(0,d.Z)(h);return u.setHours(0,0,0,0),u}},8325:(A,p,t)=>{t.d(p,{Z:()=>n});var d=t(1170);function i(h){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(g){return typeof g}:function(g){return g&&"function"==typeof Symbol&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g})(h)}function n(h){(0,d.Z)(1,arguments);var u=Object.prototype.toString.call(h);return h instanceof Date||"object"===i(h)&&"[object Date]"===u?new Date(h.getTime()):"number"==typeof h||"[object Number]"===u?new Date(h):(("string"==typeof h||"[object String]"===u)&&"undefined"!=typeof console&&(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn((new Error).stack)),new Date(NaN))}}}]);
//# sourceMappingURL=default-src_app_services_reminder_service_ts-src_app_services_swarm-group_service_ts-src_app_-104507.efe05bfcb0ce7ee6.js.map